<div class="vd-volume-bundle">
  <div
    class="vs-container"
  >
    <div
      class=""
      style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 16px;"
    >
      <span
        style="flex: 1 1 0%; height: 2px; background: rgb(128, 128, 128);"
      ></span>
      <div
        class="preview-header"
        style="text-align: center; color: rgb(0, 0, 0); font-size: 16px; font-weight: bold;"
      >
        Choose your offer
      </div>
      <span
        style="flex: 1 1 0%; height: 2px; background: rgb(128, 128, 128);"
      ></span>
    </div>
    <div
      class="offers-container"
    >
      <div
        class="offer-item"
        style="background-color: rgb(255, 255, 255); border-radius: 12px; border: 2px solid rgb(0, 0, 0); padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; position: relative;"
      >
        <div
          style="display: flex; align-items: center;"
        >
          <div
            style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgb(128, 128, 128); margin-right: 12px; display: flex; justify-content: center; align-items: center;"
          >
            <div
              style="width: 12px; height: 12px; border-radius: 50%; background-color: rgb(92, 61, 153);"
            ></div>
          </div>
          <div>
            <div
              style="color: rgb(0, 0, 0); font-size: 16px; font-weight: bold;"
            >
              Single
            </div>
            <div
              style="color: rgb(128, 128, 128); font-size: 14px; font-weight: normal;"
            >
              Standard price
            </div>
          </div>
        </div>
        <div
          style="text-align: right;"
        >
          <div
            style="color: rgb(0, 0, 0); font-size: 16px; font-weight: bold;"
          >
            ₹0
          </div>
        </div>
      </div>
      <div
        class="offer-item"
        style="background-color: rgba(230, 230, 230, 0.5); border-radius: 12px; border: 2px solid rgb(128, 128, 128); padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; position: relative;"
      >
        <div
          style="display: flex; align-items: center;"
        >
          <div
            style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgb(128, 128, 128); margin-right: 12px; display: flex; justify-content: center; align-items: center;"
          ></div>
          <div bis_size="{&quot;x&quot;:684,&quot;y&quot;:248,&quot;w&quot;:114,&quot;h&quot;:40,&quot;abs_x&quot;:924,&quot;abs_y&quot;:360}">
            <div
              style="color: rgb(0, 0, 0); font-size: 16px; font-weight: bold;"
            >
              Double
            </div>
            <div
              style="color: rgb(128, 128, 128); font-size: 14px; font-weight: normal;"
            >
              You save 10% off
            </div>
          </div>
        </div>
        <div
          style="text-align: right;"
        >
          <div
            style="color: rgb(0, 0, 0); font-size: 16px; font-weight: bold;"
          >
            ₹0
          </div>
        </div>
      </div>
      <div
        class="offer-item"
        style="background-color: rgba(230, 230, 230, 0.5); border-radius: 12px; border: 2px solid rgb(128, 128, 128); padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; position: relative;"
      >
        <div
          style="display: flex; align-items: center;"
        >
          <div
            style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgb(128, 128, 128); margin-right: 12px; display: flex; justify-content: center; align-items: center;"
          ></div>
          <div bis_size="{&quot;x&quot;:684,&quot;y&quot;:336,&quot;w&quot;:117,&quot;h&quot;:40,&quot;abs_x&quot;:924,&quot;abs_y&quot;:448}">
            <div
              style="color: rgb(0, 0, 0); font-size: 16px; font-weight: bold;"
            >
              Triple
            </div>
            <div
              style="color: rgb(128, 128, 128); font-size: 14px; font-weight: normal;"
            >
              {% comment %} You save 20% off {% endcomment %}
            </div>
          </div>
        </div>
        <div
          style="text-align: right;"
        >
          <div
            style="color: rgb(0, 0, 0); font-size: 16px; font-weight: bold;"
          >
            ₹0
          </div>
        </div>
        <div
          style="position: absolute; top: -10px; right: 20px; background-color: rgb(0, 0, 0); color: rgb(255, 255, 255); padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: normal;"
        >
          MOST POPULAR
        </div>
      </div>
    </div>
    {% comment %}
      <button
        style="margin-top: 8px; background-color: rgb(240, 240, 240); color: rgb(153, 153, 153); border: none; padding: 14px; border-radius: 6px; cursor: not-allowed; text-align: center; box-shadow: rgb(204, 204, 204) 2px 2px; font-size: 16px; width: 100%;"
      >
        ADD TO CART
      </button>
    {% endcomment %}
  </div>
</div>

{% schema %}
{
  "name": "Volume Discount",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Frequently bought together"
    },
    {
      "type": "product_list",
      "id": "products",
      "label": "Products",
      "limit": 5
    },
    {
      "type": "text",
      "id": "bundle_price",
      "label": "Bundle Price",
      "info": "Enter the discounted price for the bundle"
    },
    {
      "type": "text",
      "id": "bundle_compare_price",
      "label": "Bundle Compare Price",
      "info": "Enter the original total price for comparison"
    },
    {
      "type": "text",
      "id": "discount_text",
      "label": "Discount Text",
      "default": "Unlock Your Discount"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Claim Offer"
    }
  ]
}
{% endschema %}

<script>
  window.addEventListener('DOMContentLoaded', function () {
    // Ensure shopUrl is correctly defined. In a Shopify Liquid context,
    // `Shopify.shop` or `window.Shopify.shop` might be available,
    // or you might need to pass it from your app.
    // For this example, let's assume it's available globally or you define it.
    const shopUrl = `https://${window.Shopify.shop}`; // Example: "https://your-shop-name.myshopify.com"

    // Helper to convert RGBA object to CSS rgba() string
    const rgbaToString = (color) => {
      if (
        !color ||
        typeof color.red !== 'number' ||
        typeof color.green !== 'number' ||
        typeof color.blue !== 'number' ||
        typeof color.alpha !== 'number'
      ) {
        return 'rgba(0, 0, 0, 1)'; // Default to black if invalid
      }
      return `rgba(${color.red}, ${color.green}, ${color.blue}, ${color.alpha})`;
    };

    // Helper to map font style string to CSS font-weight
    const getFontWeight = (fontStyle) => {
      switch (fontStyle) {
        case 'Lighter':
          return 'lighter';
        case 'Regular':
          return 'normal';
        case 'Bold':
          return 'bold';
        case 'Bolder':
          return 'bolder';
        default:
          return 'normal';
      }
    };

    fetch(`${shopUrl}/apps/api/volume-discount`)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        console.log('Fetched volume discount data:', data);

        if (data.success && data.data && data.data.settings) {
          const settings = data.data.settings;
          const { bundleSettings, offerSettings, designSettings, advancedSettings } = settings;

          const vdContainer = document.querySelector('.vd-volume-bundle .vs-container');
          if (!vdContainer) {
            console.error('Volume discount container not found.');
            return;
          }

          // Clear existing static content
          vdContainer.innerHTML = '';

          // Apply spacing settings to the main container
        //   vdContainer.style.marginTop = `${spacingSettings?.spacingTop}px`;
        //   vdContainer.style.marginBottom = `${spacingSettings?.spacingBottom}px`;

          // 1. Render Header
          const headerDiv = document.createElement('div');
          headerDiv.style.display = 'flex';
          headerDiv.style.alignItems = 'center';
          headerDiv.style.justifyContent = 'center';
          headerDiv.style.gap = '10px';
          headerDiv.style.marginBottom = '16px';

          const headerTextDiv = document.createElement('div');
          headerTextDiv.className = 'preview-header';
          headerTextDiv.style.textAlign = bundleSettings?.headerSettings?.alignment;
          headerTextDiv.style.color = rgbaToString(designSettings?.textColors?.header);
          headerTextDiv.style.fontSize = `${designSettings?.typographySettings?.header?.size}px`;
          headerTextDiv.style.fontWeight = getFontWeight(designSettings?.typographySettings?.header?.fontStyle);
          headerTextDiv.textContent = bundleSettings?.headerSettings?.headerText;

          if (bundleSettings?.headerSettings?.headerLine) {
            const lineStyle = `flex: 1 1 0%; height: ${
              bundleSettings?.headerSettings?.lineThickness
            }px; background: ${rgbaToString(designSettings?.backgroundColors?.border)};`;
            const leftLine = document.createElement('span');
            leftLine.style.cssText = lineStyle;
            const rightLine = document.createElement('span');
            rightLine.style.cssText = lineStyle;
            headerDiv.appendChild(leftLine);
            headerDiv.appendChild(headerTextDiv);
            headerDiv.appendChild(rightLine);
          } else {
            headerDiv.appendChild(headerTextDiv);
          }
          vdContainer.appendChild(headerDiv);

          // 2. Render Offers
          const offersContainer = document.createElement('div');
          offersContainer.className = 'offers-container';

          offerSettings?.offers.forEach((offer, index) => {
            const isSelected = index === offerSettings?.selectedOfferIndex;

            const offerItem = document.createElement('div');  
            offerItem.className = 'offer-item';
            offerItem.style.backgroundColor = isSelected
              ? rgbaToString(designSettings?.backgroundColors?.selectedBundle)
              : rgbaToString(designSettings?.backgroundColors?.bundle);
            offerItem.style.borderRadius = `${bundleSettings?.shapeSettings?.blockRadius}px`;
            offerItem.style.border = `${bundleSettings?.shapeSettings?.blockThickness}px solid ${
              isSelected
                ? rgbaToString(designSettings?.backgroundColors?.borderSelectedBundle)
                : rgbaToString(designSettings?.backgroundColors?.border)
            }`;
            offerItem.style.padding = '16px';
            offerItem.style.marginBottom = '12px';
            offerItem.style.display = 'flex';
            offerItem.style.justifyContent = 'space-between';
            offerItem.style.alignItems = 'center';
            offerItem.style.position = 'relative';

            const leftContent = document.createElement('div');
            leftContent.style.display = 'flex';
            leftContent.style.alignItems = 'center';

            // Checkmark
            if (bundleSettings?.checkmarkSettings?.checkmarkVisibility === 'show') {
              const checkmarkDiv = document.createElement('div');
              checkmarkDiv.style.width = '20px';
              checkmarkDiv.style.height = '20px';
              checkmarkDiv.style.borderRadius = '50%';
              checkmarkDiv.style.border = `2px solid ${rgbaToString(designSettings?.backgroundColors?.border)}`;
              checkmarkDiv.style.marginRight = '12px';
              checkmarkDiv.style.display = 'flex';
              checkmarkDiv.style.justifyContent = 'center';
              checkmarkDiv.style.alignItems = 'center';

              if (isSelected) {
                const innerCheckmark = document.createElement('div');
                innerCheckmark.style.width = '12px';
                innerCheckmark.style.height = '12px';
                innerCheckmark.style.borderRadius = '50%';
                innerCheckmark.style.backgroundColor = rgbaToString(designSettings?.backgroundColors?.checkmark);
                checkmarkDiv.appendChild(innerCheckmark);
              }
              leftContent.appendChild(checkmarkDiv);
            }

            const textContent = document.createElement('div');

            const titleDiv = document.createElement('div');
            titleDiv.style.color = rgbaToString(designSettings?.textColors?.title);
            titleDiv.style.fontSize = `${designSettings?.typographySettings?.titlePrice?.size}px`;
            titleDiv.style.fontWeight = getFontWeight(designSettings?.typographySettings?.titlePrice?.fontStyle);
            titleDiv.textContent = offer?.title;
            textContent.appendChild(titleDiv);

            const subtitleDiv = document.createElement('div');
            subtitleDiv.style.color = rgbaToString(designSettings?.textColors?.subtitle);
            subtitleDiv.style.fontSize = `${designSettings?.typographySettings?.subtitleComparedPrice?.size}px`;
            subtitleDiv.style.fontWeight = getFontWeight(
              designSettings?.typographySettings?.subtitleComparedPrice?.fontStyle
            );
            subtitleDiv.textContent = offer?.subtitle;
            textContent.appendChild(subtitleDiv);

            leftContent.appendChild(textContent);
            offerItem.appendChild(leftContent);

            const rightContent = document.createElement('div');
            rightContent.style.textAlign = 'right';

            const priceDiv = document.createElement('div');
            priceDiv.style.color = rgbaToString(designSettings?.pricingColors?.price);
            priceDiv.style.fontSize = `${designSettings?.typographySettings?.titlePrice?.size}px`;
            priceDiv.style.fontWeight = getFontWeight(designSettings?.typographySettings?.titlePrice?.fontStyle);
            // Placeholder for price, as it's not in the provided data structure
            // You'll need to calculate or fetch the actual price based on quantity and discount
            priceDiv.textContent = `₹0`; // Replace with actual price logic
            rightContent.appendChild(priceDiv);

            offerItem.appendChild(rightContent);

            // Highlight Tag
            if (offer?.highlight && offer?.highlightSettings && offer?.highlightSettings?.text) {
              const highlightTag = document.createElement('div');
              highlightTag.style.position = 'absolute';
              highlightTag.style.top = '-10px';
              highlightTag.style.right = '20px';
              highlightTag.style.backgroundColor = rgbaToString(designSettings?.backgroundColors?.highlight);
              highlightTag.style.color = rgbaToString(designSettings?.textColors?.highlight);
              highlightTag.style.padding = '4px 8px';
              highlightTag.style.borderRadius = offer?.highlightSettings?.shape === 'rounded' ? '12px' : '0'; // Adjust based on shape
              highlightTag.style.fontSize = `${designSettings?.typographySettings?.tagHighlight?.size}px`;
              highlightTag.style.fontWeight = getFontWeight(designSettings?.typographySettings?.tagHighlight?.fontStyle);
              highlightTag.textContent = offer?.highlightSettings?.text;
              offerItem.appendChild(highlightTag);
            }

            offersContainer.appendChild(offerItem);
          });

          vdContainer.appendChild(offersContainer);

          // Add the "ADD TO CART" button (if needed, currently commented out in Liquid)
          // You would need to uncomment and dynamically style this as well
          // const addToCartButton = document.createElement('button');
          // addToCartButton.style.cssText = `margin-top: 8px; background-color: rgb(240, 240, 240); color: rgb(153, 153, 153); border: none; padding: 14px; border-radius: 6px; cursor: not-allowed; text-align: center; box-shadow: rgb(204, 204, 204) 2px 2px; font-size: 16px; width: 100%;`;
          // addToCartButton.textContent = 'ADD TO CART';
          // vdContainer.appendChild(addToCartButton);
        } else {
          console.warn('Volume discount settings not found or data is not successful.');
          // Optionally, hide the block or show a fallback message
          const vdBlock = document.querySelector('.vd-volume-bundle');
          if (vdBlock) vdBlock.style.display = 'none';
        }
      })
      .catch((error) => {
        console.error('Error fetching volume discount settings:', error);
        // Optionally, hide the block or show an error message
        const vdBlock = document.querySelector('.vd-volume-bundle');
        if (vdBlock) vdBlock.style.display = 'none';
      });
  });
</script>

<script>
  // ---- object coming from data ----
  //     {
  //     "success": true,
  //     "message": "Volume discount settings loaded successfully.",
  //     "data": {
  //         "id": 1,
  //         "shop": "gid://shopify/Shop/73863725283",
  //         "bundleName": "Bundle 1",
  //         "settings": {
  //             "offerSettings": {
  //                 "offers": [
  //                     {
  //                         "id": "offer-1",
  //                         "tag": "",
  //                         "image": null,
  //                         "title": "Single",
  //                         "quantity": "1",
  //                         "subtitle": "Standard price",
  //                         "highlight": false,
  //                         "priceType": "default",
  //                         "buyQuantity": "1",
  //                         "getQuantity": "1",
  //                         "highlightSettings": {
  //                             "text": "MOST POPULAR",
  //                             "type": "text",
  //                             "shape": "rounded",
  //                             "style": "pill",
  //                             "blinking": false
  //                         },
  //                         "selectedByDefault": true
  //                     },
  //                     {
  //                         "id": "offer-2",
  //                         "tag": "",
  //                         "image": null,
  //                         "title": "Double",
  //                         "quantity": "2",
  //                         "subtitle": "You save 10% off",
  //                         "highlight": false,
  //                         "priceType": "default",
  //                         "buyQuantity": "1",
  //                         "getQuantity": "1",
  //                         "highlightSettings": {
  //                             "text": "MOST POPULAR",
  //                             "type": "text",
  //                             "shape": "rounded",
  //                             "style": "pill",
  //                             "blinking": false
  //                         },
  //                         "selectedByDefault": true
  //                     },
  //                     {
  //                         "id": "offer-3",
  //                         "tag": "",
  //                         "image": null,
  //                         "title": "Triple",
  //                         "quantity": "3",
  //                         "subtitle": "You save 20% off",
  //                         "highlight": true,
  //                         "priceType": "default",
  //                         "buyQuantity": "1",
  //                         "getQuantity": "1",
  //                         "highlightSettings": {
  //                             "text": "MOST POPULAR",
  //                             "type": "text",
  //                             "shape": "rounded",
  //                             "style": "pill",
  //                             "blinking": false
  //                         },
  //                         "selectedByDefault": true
  //                     }
  //                 ],
  //                 "selectedOfferIndex": 0
  //             },
  //             "bundleSettings": {
  //                 "bundleName": "Bundle 1",
  //                 "shapeSettings": {
  //                     "blockRadius": 12,
  //                     "blockThickness": 2
  //                 },
  //                 "headerSettings": {
  //                     "alignment": "center",
  //                     "headerLine": true,
  //                     "headerText": "Choose your offer",
  //                     "lineThickness": 2
  //                 },
  //                 "checkmarkSettings": {
  //                     "checkmarkVisibility": "show"
  //                 },
  //                 "visibilitySettings": {
  //                     "visibility": "all_products"
  //                 }
  //             },
  //             "designSettings": {
  //                 "textColors": {
  //                     "tags": {
  //                         "red": 128,
  //                         "blue": 128,
  //                         "alpha": 1,
  //                         "green": 128
  //                     },
  //                     "title": {
  //                         "red": 0,
  //                         "blue": 0,
  //                         "alpha": 1,
  //                         "green": 0
  //                     },
  //                     "header": {
  //                         "red": 0,
  //                         "blue": 0,
  //                         "alpha": 1,
  //                         "green": 0
  //                     },
  //                     "subtitle": {
  //                         "red": 128,
  //                         "blue": 128,
  //                         "alpha": 1,
  //                         "green": 128
  //                     },
  //                     "highlight": {
  //                         "red": 255,
  //                         "blue": 255,
  //                         "alpha": 1,
  //                         "green": 255
  //                     }
  //                 },
  //                 "pricingColors": {
  //                     "price": {
  //                         "red": 0,
  //                         "blue": 0,
  //                         "alpha": 1,
  //                         "green": 0
  //                     },
  //                     "comparedPrice": {
  //                         "red": 255,
  //                         "blue": 0,
  //                         "alpha": 1,
  //                         "green": 0
  //                     }
  //                 },
  //                 "backgroundColors": {
  //                     "tags": {
  //                         "red": 128,
  //                         "blue": 128,
  //                         "alpha": 0.5,
  //                         "green": 128
  //                     },
  //                     "border": {
  //                         "red": 128,
  //                         "blue": 128,
  //                         "alpha": 1,
  //                         "green": 128
  //                     },
  //                     "bundle": {
  //                         "red": 230,
  //                         "blue": 230,
  //                         "alpha": 0.5,
  //                         "green": 230
  //                     },
  //                     "checkmark": {
  //                         "red": 0,
  //                         "blue": 0,
  //                         "alpha": 1,
  //                         "green": 0
  //                     },
  //                     "highlight": {
  //                         "red": 0,
  //                         "blue": 0,
  //                         "alpha": 1,
  //                         "green": 0
  //                     },
  //                     "selectedBundle": {
  //                         "red": 255,
  //                         "blue": 255,
  //                         "alpha": 1,
  //                         "green": 255
  //                     },
  //                     "borderSelectedBundle": {
  //                         "red": 0,
  //                         "blue": 0,
  //                         "alpha": 1,
  //                         "green": 0
  //                     }
  //                 },
  //                 "openColorPickerFor": null,
  //                 "typographySettings": {
  //                     "header": {
  //                         "size": "16",
  //                         "fontStyle": "Bold"
  //                     },
  //                     "titlePrice": {
  //                         "size": "16",
  //                         "fontStyle": "Bold"
  //                     },
  //                     "tagHighlight": {
  //                         "size": "12",
  //                         "fontStyle": "Regular"
  //                     },
  //                     "subtitleComparedPrice": {
  //                         "size": "14",
  //                         "fontStyle": "Regular"
  //                     }
  //                 }
  //             },
  //             "advancedSettings": {
  //                 "pricing": {
  //                     "showPricesPerItem": false,
  //                     "showCompareAtPrice": true
  //                 },
  //                 "variants": {
  //                     "hideOutOfStock": false,
  //                     "hideThemePrice": true,
  //                     "hideThemeVariant": true,
  //                     "allowCustomerChoice": true
  //                 }
  //             }
  //         },
  //         "status": "published",
  //         "createdAt": "2025-06-28T22:51:37.798Z",
  //         "updatedAt": "2025-06-29T00:31:27.042Z"
  //     }
  // }
</script>
